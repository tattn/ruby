$nop
$putself
$putobject
$putobject_OP_INT2FIX_O_0_C_
$putobject_OP_INT2FIX_O_1_C_

$getspecial {
    // val = vm_getspecial(th, GET_LEP(), key, type);
}

$opt_plus {
	Value *tmp = BUILDER->CreateAnd(obj, -2);
	val = BUILDER->CreateAdd(recv, tmp);
}

$opt_minus {
	Value *a, *b, *c;

	a = FIX2LONG(recv);
	b = FIX2LONG(obj);
	c = BUILDER->CreateSub(a, b);
	val = LONG2FIX(c);
}

$opt_mult {
	Value *a, *b;

	a = FIX2LONG(recv);
	b = FIX2LONG(obj);
	val = LONG2FIX(BUILDER->CreateMul(a, b));
}

$opt_div {
	Value *x, *y, *div;

	x = FIX2LONG(recv);
	y = FIX2LONG(obj);
	div = BUILDER->CreateSDiv(x, y);
	val = LONG2NUM(div);
}

$send {
	BUILDER->CreateCall4(RB_JIT->llvm_caller_setup_arg_block, JIT_TH, JIT_CFP, ci, RB_JIT->int32Zero);
	BUILDER->CreateCall2(RB_JIT->llvm_search_method, ci, TOPN(rb_ci->argc));
	Value *ci_call_elmptr = BUILDER->CreateStructGEP(ci, 14);
	Value *ci_call = BUILDER->CreateLoad(ci_call_elmptr);
	CALL_METHOD(ci);
}

$opt_send_without_block {
	rb_ci->argc = rb_ci->orig_argc;
	BUILDER->CreateCall2(RB_JIT->llvm_search_method, ci, TOPN(rb_ci->argc));
	Value *ci_call_elmptr = BUILDER->CreateStructGEP(ci, 14);
	Value *ci_call = BUILDER->CreateLoad(ci_call_elmptr);
	CALL_METHOD(ci);
}

$setlocal {
/*
    int i, lev = (int)level;
    VALUE *ep = GET_EP();

    for (i = 0; i < lev; i++) {
	ep = GET_PREV_EP(ep);
    }
    *(ep - idx) = val;
*/
}

$setlocal_OP__WC__0 {
	Value *ep = GET_EP();

	Value *idx_ep = BUILDER->CreateInBoundsGEP(ep, BUILDER->CreateSub(RB_JIT->valueZero, idx));
	BUILDER->CreateStore(val, idx_ep);
}

$getlocal {
/*
    int i, lev = (int)level;
    VALUE *ep = GET_EP();

    for (i = 0; i < lev; i++) {
	ep = GET_PREV_EP(ep);
    }
    val = *(ep - idx);
*/
}

$getlocal_OP__WC__0 {
	Value *ep = GET_EP();

	Value *idx_ep = BUILDER->CreateInBoundsGEP(ep, BUILDER->CreateSub(RB_JIT->valueZero, idx));
	val = BUILDER->CreateLoad(idx_ep);
}

$branchunless {
	Value *test = RTEST(val);
	BasicBlock *bb_dst  = insns[insn->index + insn->len + dst]->bb;
	BasicBlock *bb_next = insns[insn->index + insn->len      ]->bb;
	BUILDER->CreateCondBr(test, bb_next, bb_dst);
}
